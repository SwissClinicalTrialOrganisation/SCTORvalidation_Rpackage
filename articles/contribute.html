<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="validation">
<title>Contributing new tests • validation</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Contributing new tests">
<meta property="og:description" content="validation">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">validation</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.6</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/contribute.html">Contributing new tests</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/SwissClinicalTrialOrganisation/validation/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Contributing new tests</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/SwissClinicalTrialOrganisation/validation/blob/HEAD/vignettes/contribute.Rmd" class="external-link"><code>vignettes/contribute.Rmd</code></a></small>
      <div class="d-none name"><code>contribute.Rmd</code></div>
    </div>

    
    
<p>This package contains a set of functions for to assist in the running
and reporting of tests that have been published on the SCTO platform.
The tests themselves are located in the <a href="www.github.com/SwissClinicalTrialOrganisation/validation_tests">validation_tests</a>
repository. The results of the tests are then published as issues in the
<a href="www.github.com/SwissClinicalTrialOrganisation/pkg_validation">pkg_validation</a>
repository.</p>
<p>Tests are written using functions from the <a href="https://testthat.r-lib.org/" class="external-link">testthat</a> package, and can be
downloaded, run, and reported using the functions in this package.</p>
<div class="section level2">
<h2 id="test_skeleton-helps-build-the-structure">
<code>test_skeleton</code> helps build the structure<a class="anchor" aria-label="anchor" href="#test_skeleton-helps-build-the-structure"></a>
</h2>
<p>The <code>test_skeleton</code> function can be used to create the
relevant folder structure for testing a new package, or adding a file
for testing additional functions. In the code below, substitute
<code>pkg</code> with the name of the package to be tested and add the
names of the function(s) you want to test in the <code>funs</code>
argument.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_skeleton.html">test_skeleton</a></span><span class="op">(</span><span class="st">"pkg"</span>, funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fun"</span>, <span class="st">"fun2"</span>, <span class="st">"etc"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This will create a set of files in your working directory:</p>
<pre><code><span><span class="op">-</span><span class="op">-</span> <span class="va">pkg</span></span>
<span>   <span class="op">+</span><span class="op">-</span> <span class="va">info.txt</span></span>
<span>   <span class="op">+</span><span class="op">-</span> <span class="va">setup</span><span class="op">-</span><span class="va">pkg.R</span></span>
<span>   <span class="op">+</span><span class="op">-</span> <span class="va">test</span><span class="op">-</span><span class="va">fun.R</span></span>
<span>   <span class="op">+</span><span class="op">-</span> <span class="va">test</span><span class="op">-</span><span class="va">fun2.R</span></span>
<span>   <span class="op">+</span><span class="op">-</span> <span class="va">test</span><span class="op">-</span><span class="va">etc.R</span></span></code></pre>
<ul>
<li>
<code>info.txt</code> file will contain the name of the package and
a freetext description of what is tested,</li>
<li>
<code>setup-pkg.R</code> is for any necessary setup code
(e.g. installation of the package),</li>
<li>for each function in the <code>funs</code> argument, a
<code>test-function.R</code> file is created, which will contain the
actual testing code.</li>
</ul>
<p>In the event that the package already has tests, the
<code>test_skeleton</code> function will not overwrite the existing
files, only adding any necessary <code>test-function.R</code> files.</p>
<p>Add the relevant tests to the <code>test-function.R</code> files and
check that they work as expected (run <code><a href="https://devtools.r-lib.org/reference/load_all.html" class="external-link">devtools::load_all()</a></code>
followed by <code>test("package")</code>).</p>
</div>
<div class="section level2">
<h2 id="submitting-tests-to-the-platform">Submitting tests to the platform<a class="anchor" aria-label="anchor" href="#submitting-tests-to-the-platform"></a>
</h2>
<p>Once you have added the necessary tests (see the next section), add
the files to the <a href="https://github.com/SwissClinicalTrialOrganisation/validation_tests" class="external-link">validation_tests
repository</a>. The easiest way is to navigate to the tests folder,
click on “Add file” and then “Upload files”. Now you can simply drag the
<code>pkg</code> folder into the browser window and commit the change.
This will have forked the repository to your own GitHub account, and you
can now create a pull request to the original repository to incorporate
your code. It is also possible to fork the repository, clone it to your
computer and make the commit there, but this is not strictly
necessary.</p>
<p>At this stage, the four-eye principle will be applied to the pull
request to check the adequacy and quality of the tests and code. If the
reviewer agrees with your tests, they will be merged into the package.
If they note any issues, which you will see as comments in the GitHub
pull request, you will need to address them before the tests can be
merged.</p>
<p>Once merged, the tests can be run via the validation package
<code>validation::test("packagename")</code> and documented in the
repository at <a href="https://github.com/SwissClinicalTrialOrganisation/pkg_validation" class="external-link">https://github.com/SwissClinicalTrialOrganisation/pkg_validation</a>.</p>
</div>
<div class="section level2">
<h2 id="writing-tests">Writing tests<a class="anchor" aria-label="anchor" href="#writing-tests"></a>
</h2>
<p>Testing is performed via the <a href="https://testthat.r-lib.org/" class="external-link">testthat</a> framework. All tests for
a given function should be placed in a dedicated
<code>test-function.R</code> file.</p>
<p>Each test is comprised of one or more expectations and a descriptive
name.</p>
<p>E.g.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"some meaningful message about the tests"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_false</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">is.character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Where multiple tests are to be made on what could be a single object,
it is often useful to create the object outside of the
<code>test_that</code> function. This is particularly useful when
different descriptive texts should be shown for the tests (e.g. perhaps
the coefficients and standard errors from a model):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">some_function</span><span class="op">(</span><span class="va">params</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"test 1 on obj"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">value_to_test</span>, <span class="va">expected_value</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"test 2 on obj"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">another_value_to_test</span>, <span class="va">expected_value</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>If objects are only useful to the test, they can be created within
the <code>test_that</code> function.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"tests on obj"</span>, <span class="op">{</span></span>
<span>  <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">some_function</span><span class="op">(</span><span class="va">params</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">value_to_test</span>, <span class="va">expected_value</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">another_value_to_test</span>, <span class="va">expected_value</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Making the description of the test meaningful is important, as it
will help the user diagnose where the problem is.</p>
<p><code>testthat</code> supports a large number of expectations, which
are documented in the <a href="https://testthat.r-lib.org/reference/index.html" class="external-link">testthat
documentation</a>. We demonstrate a few examples below.</p>
<div class="section level3">
<h3 id="compare-computation-to-a-reference-value">Compare computation to a reference value<a class="anchor" aria-label="anchor" href="#compare-computation-to-a-reference-value"></a>
</h3>
<p>To test the computation of the function, the following code must be
added to the testing file, for as many test cases as considered
appropriate:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"function f works"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Where f is the function to be tested, x are the input parameters for
the function and y is the expected returned value.</p>
<p>Note that is/may be necessary/desirable to set a tolerance for
floating point comparisons. This can be done with the
<code>tolerance</code> argument.</p>
</div>
<div class="section level3">
<h3 id="testing-for-errors-warnings-and-other-messages">Testing for errors, warnings and other messages<a class="anchor" aria-label="anchor" href="#testing-for-errors-warnings-and-other-messages"></a>
</h3>
<p>To test whether, under certain conditions, the function returns an
error, a warning or a message, the following corresponding code can be
adapted, for as many test cases as considered appropriate:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"function f returns an error"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html" class="external-link">expect_error</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"function f returns a warning"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html" class="external-link">expect_warning</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"function f returns a message"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html" class="external-link">expect_message</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Where f is the function to be tested, x are the arguments that define
the conditions. Use the <code>regexp</code> argument to check for a
particular error, warning or message.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"function f returns an error"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html" class="external-link">expect_error</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, regexp <span class="op">=</span> <span class="st">"some error message"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>In contrast, to test whether the function runs without returning an
error, a warning or a message, the following corresponding code can be
adapted, for as many test cases as considered appropriate:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"function f runs without error"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_no_error.html" class="external-link">expect_no_error</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"function f runs without a warning"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html" class="external-link">expect_warning</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"function f runs without a message"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html" class="external-link">expect_message</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="testing-booleans">Testing booleans<a class="anchor" aria-label="anchor" href="#testing-booleans"></a>
</h3>
<p>To test whether, under certain conditions, the function returns TRUE
or FALSE, adapt the following code as appropriate:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"function f returns TRUE"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"function f returns FALSE"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_false</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Where f is the function to be tested, x are the arguments that define
the conditions.</p>
</div>
<div class="section level3">
<h3 id="testing-for-null">Testing for NULL<a class="anchor" aria-label="anchor" href="#testing-for-null"></a>
</h3>
<p>To test whether, under certain conditions, the function returns NULL,
the following code can be adapted, for as many test cases as considered
appropriate:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"function f returns NULL"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_null.html" class="external-link">expect_null</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="testing-the-type-of-object-returned-base-r">Testing the type of object returned (base R)<a class="anchor" aria-label="anchor" href="#testing-the-type-of-object-returned-base-r"></a>
</h3>
<p>To test whether, the function returns an object of a certain type,
the following code can be adapted, for as many test cases as considered
appropriate:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"function f returns object of type XXX"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/inheritance-expectations.html" class="external-link">expect_type</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="va">type</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Where f is the function to be tested, x are the arguments that define
the conditions and type is any of the following: “integer”, “character”,
“factor”, “logical”, “double”.</p>
</div>
<div class="section level3">
<h3 id="testing-the-class-s3-of-an-object">Testing the class (s3) of an object<a class="anchor" aria-label="anchor" href="#testing-the-class-s3-of-an-object"></a>
</h3>
<p>To test whether, the function returns an object of class s3, the
following code can be adapted, for as many cases as considered
appropriate:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"function f returns object of class s3"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/inheritance-expectations.html" class="external-link">expect_s3_class</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="va">class</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Where f is the function to be tested, x are the arguments that define
the conditions and class is, among others, any of the following:
“data.frame”, “factor”, “Date”, “POSIXct”, etc.</p>
</div>
<div class="section level3">
<h3 id="running-tests-under-certain-conditions">Running tests under certain conditions<a class="anchor" aria-label="anchor" href="#running-tests-under-certain-conditions"></a>
</h3>
<p>On occasion, it may be desirable to restrict the tests to specific
package versions. This can be done by using the <code>skip_if</code>
functions in <code>testthat</code>.</p>
<p>For example, the pivot functions we introduced to tidyr in version
1.0.0. If we have tests on those functions, we can restrict them to
versions 1.0.0 and above with the following code:</p>
<pre><code><span><span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html" class="external-link">skip_if</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"tidyr"</span><span class="op">)</span> <span class="op">&lt;</span> <span class="st">"1.0.0"</span><span class="op">)</span></span></code></pre>
<p>This line can be placed at the top of the test file, before any tests
are run. The equivalent can be done for versions below a certain
version, which might be useful for deprecated functions.</p>
<p>It might be suitable to stop tests from being run if the internet is
not available:</p>
<pre><code><span><span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html" class="external-link">skip_if_offline</a></span><span class="op">(</span><span class="op">)</span></span></code></pre>
<p>Or if a package can only be run on a specific operating system:</p>
<pre><code><span><span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html" class="external-link">skip_on_os</a></span><span class="op">(</span><span class="st">"mac"</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="using-data-in-tests">Using data in tests<a class="anchor" aria-label="anchor" href="#using-data-in-tests"></a>
</h3>
<p>It is often necessary to use data in tests. R includes a number of
built-in datasets that can be used for this purpose (e.g. iris,
mtcars).</p>
<p>The <a href="https://doi.org/10.32614/CRAN.package.medicaldata" class="external-link">medicaldata</a>
R package also contains a number of datasets, primarily from published
sources.</p>
<p>The SCTO validation platform also has a <a href="https://github.com/SwissClinicalTrialOrganisation/validation_tests/tree/main/datasets" class="external-link">location
for additional datasets</a>, which may also be used.</p>
<p>In order to access datasets within tests, the
<code>get_test_data</code> function can be used in the
<code>setup-pkg.R</code> file. Suppose we want to use the
<code>mtcars.csv</code> dataset from the repository. We might use the
following setup-stats.R file:</p>
<pre><code><span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"stats"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org" class="external-link">testthat</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/get_test_data.html">get_test_data</a></span><span class="op">(</span><span class="st">"mtcars.csv"</span><span class="op">)</span></span>
<span><span class="va">mtcars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"mtcars.csv"</span><span class="op">)</span></span>
<span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">defer</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># most of the time, we would want to detach packages, in this case we don't</span></span>
<span>  <span class="co"># detach(package:stats)</span></span>
<span><span class="op">}</span>, <span class="fu"><a href="https://testthat.r-lib.org/reference/teardown_env.html" class="external-link">teardown_env</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre>
<p>We do not need to worry about the location the file is saved to as
the <code>test</code> function, via <code>testthat</code>, sets the
working directory to the package-tests directory.</p>
<p>Where a new dataset might be useful when testing multiple packages,
it can be added to the datasets folder in the validation_tests
repository via a pull request.</p>
</div>
</div>
<div class="section level2">
<h2 id="worked-example">Worked example<a class="anchor" aria-label="anchor" href="#worked-example"></a>
</h2>
<p>Theory is all well and good, but it’s always useful to see how that
would be in practice.</p>
<p>Assume that we want to check that the <code>lm</code> function from
the <code>stats</code> package works as expected. We can write a test
file that checks that the function returns the expected coefficients and
standard errors.</p>
<p>The following assumes that we have cloned the validation repository
to our computer and we are within that project.</p>
<p>To begin with, we construct the testing files, specifically the
<code>test_skeleton</code> function. We only want to test the
<code>lm</code> function, so we only pass that to the second
argument:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/test_skeleton.html">test_skeleton</a></span><span class="op">(</span><span class="st">"stats"</span>, <span class="st">"lm"</span><span class="op">)</span></span></code></pre></div>
<p>This will have created a <code>stats</code> folder within inst/tests.
Within that folder, there will be files called <code>info.txt</code>,
<code>setup-stats.R</code>, and <code>test-lm.R</code>.</p>
<div class="section level3">
<h3 id="test-lm-r">
<code>test-lm.R</code><a class="anchor" aria-label="anchor" href="#test-lm-r"></a>
</h3>
<p>First we will write the actual tests that we want to run. Tests are
entered into the <code>test-lm.R</code> file. Opening that file, we see
that there are just a few comments at the top of the file, with some
reminders.</p>
<pre><code><span><span class="co"># Write relevent tests for the function in here</span></span>
<span><span class="co"># Consider the type of function:</span></span>
<span><span class="co">#   - is it deterministic or statistic?</span></span>
<span><span class="co">#   - is it worth checking for errors/warnings under particular conditions?</span></span></code></pre>
<p>We decide that we will use the mtcars dataset as our basis for
testing <code>lm</code>, so we can load the dataset. We want to test
both the linear effect of the number of cylinders on the miles per
gallon, and the effect of the number of cylinders (<code>cyl</code>), as
well as when <code>cyl</code> is treated as a factor.</p>
<pre><code><span><span class="co"># Write relevent tests for the function in here</span></span>
<span><span class="co"># Consider the type of function:</span></span>
<span><span class="co">#   - is it deterministic or statistic?</span></span>
<span><span class="co">#   - is it worth checking for errors/warnings under particular conditions?</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="va">mtcars</span><span class="op">$</span><span class="va">cyl_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span></span></code></pre>
<p>Note that if there are multiple functions being tested (each in their
own test-function.R file) that require the same data, we can load and
prepare the data in the <code>setup-stats.R</code> file.</p>
<p>We can also define the models that we want to test:</p>
<pre><code><span><span class="va">cmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">cyl</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="va">fmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">cyl_f</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span></code></pre>
<p>We do not include the model definitions within a test_that call
because we will use the same models in multiple tests. Again, if we
needed to use those models for testing multiple functions, we could
define them in the setup file.</p>
<div class="section level4">
<h4 id="testing-coefficients">Testing coefficients<a class="anchor" aria-label="anchor" href="#testing-coefficients"></a>
</h4>
<p>Suppose that we know that the coefficient for <code>mpg ~ cyl</code>
is known (-2.88 for the linear effect). We can write a test that checks
that expectation:</p>
<pre><code><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"lm returns the expected coefficients"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">cmod</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="op">-</span><span class="fl">2.88</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre>
<p>Due to floating point precision, this is probably insufficient - R
will not return exactly -2.88. We can use the <code>tolerance</code>
argument to check that the coefficient is within a certain range (we
could also round the coefficient). We also need to tell
<code>expect_equal</code> to ignore the names attribute of the vector,
otherwise it compares the whole object, attributes and all:</p>
<pre><code><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"lm returns the expected coefficients"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">cmod</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="op">-</span><span class="fl">2.88</span>, tolerance <span class="op">=</span> <span class="fl">0.01</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre>
<p>We can do the same for the coefficients from the model with
<code>cyl_f</code>. This time, we can derive the values from the
<code>tapply</code> function as, in this case, the coefficients are just
the means:</p>
<pre><code><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"lm returns the expected coefficients"</span>, <span class="op">{</span></span>
<span>  <span class="va">means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span>, <span class="va">mean</span><span class="op">)</span></span>
<span>  <span class="va">coefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fmod</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">means</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">means</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">means</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">means</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">means</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre>
<p>We have now performed 4 tests (the expectations) in two
<code>test_that</code> calls. We can also combine them together:</p>
<pre><code><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"lm returns the expected coefficients"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">cmod</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="op">-</span><span class="fl">2.88</span>, tolerance <span class="op">=</span> <span class="fl">0.01</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span>, <span class="va">mean</span><span class="op">)</span></span>
<span>  <span class="va">coefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fmod</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">means</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">means</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">means</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">means</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">means</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre>
<p>Whether to put them in one or two calls is up to the author.
Distributing them across more calls helps identify which tests fail, but
it also makes the file longer.</p>
<div class="section level5">
<h5 id="a-note-on-selecting-tolerances">A note on selecting tolerances<a class="anchor" aria-label="anchor" href="#a-note-on-selecting-tolerances"></a>
</h5>
<p>The tolerance is a tricky thing to select. It is a balance between
being too strict and too lenient. If the tolerance is too strict, then
the test will fail when the function is working as expected. If the
tolerance is too lenient, then the test will pass when the function is
not working as expected.</p>
<p>Consider the example above. We compared -2.88 with the coefficient
which R reports to (at least) 5 decimal places. In this case, it does
not make sense to use a tolerance of less than 0.01 because we only know
the coefficient to two decimal places (even though we would have access
to a far greater precision had we worked for it).</p>
<p>Generally speaking, values that are easy to calculate should probably
have a lower tolerance. Values that are very dependent on specifics of
the implementation (e.g. maximisation algorithm, etc) should probably
have a higher tolerance. This is especially the case when using external
software as a reference (e.g. Stata uses different defaults settings to
<code>lme4</code>, causing differences in SEs). Simulation results, may
also require a more lenient tolerance.</p>
</div>
</div>
<div class="section level4">
<h4 id="testing-the-standard-errors-against-stata">Testing the standard errors against Stata<a class="anchor" aria-label="anchor" href="#testing-the-standard-errors-against-stata"></a>
</h4>
<p>Suppose that we have used Stata as a reference software for the
standard errors. We include the commands used in the reference software
in comments in the script, including the output and the information of
the version of the reference software.</p>
<pre><code><span><span class="co"># write.csv(mtcars, "mtcars.csv", row.names = FALSE)</span></span>
<span><span class="co"># reference software: Stata 17.0 (revision 2024-02-13)</span></span>
<span><span class="co"># import delimited "mtcars.csv"</span></span>
<span><span class="co"># regress mpg cyl</span></span>
<span><span class="co"># [output truncated for brevity]</span></span>
<span><span class="co"># ------------------------------------------------------------------------------</span></span>
<span><span class="co">#          mpg | Coefficient  Std. err.      t    P&gt;|t|     [95% conf. interval]</span></span>
<span><span class="co"># -------------+----------------------------------------------------------------</span></span>
<span><span class="co">#          cyl |   -2.87579   .3224089    -8.92   0.000    -3.534237   -2.217343</span></span>
<span><span class="co">#        _cons |   37.88458   2.073844    18.27   0.000     33.64922    42.11993</span></span>
<span><span class="co"># ------------------------------------------------------------------------------</span></span>
<span><span class="co"># [output truncated for brevity]</span></span>
<span><span class="co"># regress mpg i.cyl</span></span>
<span><span class="co"># [output truncated for brevity]</span></span></code></pre>
<p>We can then use the SE values from Stata in the tests, specifying a
suitable tolerance (it’s pretty simple to calculate, so we can be quite
stringent):</p>
<pre><code><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"Standard errors from LM are correct"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">cmod</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span>, <span class="fl">0.322408</span>, </span>
<span>               tolerance <span class="op">=</span> <span class="fl">0.00001</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fmod</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span>, <span class="fl">1.558348</span>, </span>
<span>               tolerance <span class="op">=</span> <span class="fl">0.00001</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fmod</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">]</span>, <span class="fl">1.298623</span>, </span>
<span>               tolerance <span class="op">=</span> <span class="fl">0.0001</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="the-completed-test-file">The completed test file<a class="anchor" aria-label="anchor" href="#the-completed-test-file"></a>
</h4>
<p>The test file including the tests above is then:</p>
<pre><code><span><span class="co"># Write relevent tests for the function in here</span></span>
<span><span class="co"># Consider the type of function:</span></span>
<span><span class="co">#   - is it deterministic or statistic?</span></span>
<span><span class="co">#   - is it worth checking for errors/warnings under particular conditions?</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/local_edition.html" class="external-link">local_edition</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="va">mtcars</span><span class="op">$</span><span class="va">cyl_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">cyl</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="va">fmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">cyl_f</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"lm returns the expected coefficients"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">cmod</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="op">-</span><span class="fl">2.88</span>, tolerance <span class="op">=</span> <span class="fl">0.01</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span>, <span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span>, <span class="va">mean</span><span class="op">)</span></span>
<span>  <span class="va">coefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fmod</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">means</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">means</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">means</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">means</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">means</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># write.csv(mtcars, "mtcars.csv", row.names = FALSE)</span></span>
<span><span class="co"># reference software: Stata 17.0 (revision 2024-02-13)</span></span>
<span><span class="co"># import delimited "mtcars.csv"</span></span>
<span><span class="co"># regress mpg cyl</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#       Source |       SS           df       MS      Number of obs   =        32</span></span>
<span><span class="co"># -------------+----------------------------------   F(1, 30)        =     79.56</span></span>
<span><span class="co">#        Model |  817.712952         1  817.712952   Prob &gt; F        =    0.0000</span></span>
<span><span class="co">#     Residual |  308.334235        30  10.2778078   R-squared       =    0.7262</span></span>
<span><span class="co"># -------------+----------------------------------   Adj R-squared   =    0.7171</span></span>
<span><span class="co">#        Total |  1126.04719        31  36.3241028   Root MSE        =    3.2059</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># ------------------------------------------------------------------------------</span></span>
<span><span class="co">#          mpg | Coefficient  Std. err.      t    P&gt;|t|     [95% conf. interval]</span></span>
<span><span class="co"># -------------+----------------------------------------------------------------</span></span>
<span><span class="co">#          cyl |   -2.87579   .3224089    -8.92   0.000    -3.534237   -2.217343</span></span>
<span><span class="co">#        _cons |   37.88458   2.073844    18.27   0.000     33.64922    42.11993</span></span>
<span><span class="co"># ------------------------------------------------------------------------------</span></span>
<span><span class="co"># regress mpg i.cyl</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#       Source |       SS           df       MS      Number of obs   =        32</span></span>
<span><span class="co"># -------------+----------------------------------   F(2, 29)        =     39.70</span></span>
<span><span class="co">#        Model |   824.78459         2  412.392295   Prob &gt; F        =    0.0000</span></span>
<span><span class="co">#     Residual |  301.262597        29  10.3883654   R-squared       =    0.7325</span></span>
<span><span class="co"># -------------+----------------------------------   Adj R-squared   =    0.7140</span></span>
<span><span class="co">#        Total |  1126.04719        31  36.3241028   Root MSE        =    3.2231</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># ------------------------------------------------------------------------------</span></span>
<span><span class="co">#          mpg | Coefficient  Std. err.      t    P&gt;|t|     [95% conf. interval]</span></span>
<span><span class="co"># -------------+----------------------------------------------------------------</span></span>
<span><span class="co">#          cyl |</span></span>
<span><span class="co">#           6  |  -6.920779   1.558348    -4.44   0.000    -10.10796   -3.733599</span></span>
<span><span class="co">#           8  |  -11.56364   1.298623    -8.90   0.000    -14.21962   -8.907653</span></span>
<span><span class="co">#              |</span></span>
<span><span class="co">#        _cons |   26.66364   .9718008    27.44   0.000     24.67608    28.65119</span></span>
<span><span class="co"># ------------------------------------------------------------------------------</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"Standard errors from lm are correct"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">cmod</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span>, <span class="fl">0.322408</span>, </span>
<span>               tolerance <span class="op">=</span> <span class="fl">0.0001</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fmod</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span>, <span class="fl">1.558348</span>, </span>
<span>               tolerance <span class="op">=</span> <span class="fl">0.0001</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fmod</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">]</span>, <span class="fl">1.298623</span>, </span>
<span>               tolerance <span class="op">=</span> <span class="fl">0.0001</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre>
<p>For <code>lm</code>, other things that might be tested include the
R-squared, the F-statistic, and the p-values. Generally speaking, we
might also want to test that the model is of the appropriate class (also
<code>lm</code> in this case), or that the model has the expected number
of coefficients, that the function issues warnings and/or errors at
appropriate times.</p>
</div>
</div>
<div class="section level3">
<h3 id="info-txt">
<code>info.txt</code><a class="anchor" aria-label="anchor" href="#info-txt"></a>
</h3>
<p>It is easiest to write the <code>info.txt</code> file once all tests
have been written. It provides a listing of what has been tested in
prose form and serves as a quick overview of the tests.</p>
<p>The default text the file contains a single line:</p>
<pre><code>Tests for package stats</code></pre>
<p>Extra details on the tests that we have performed should be added. In
this case, we might modify it to:</p>
<pre><code>Tests for package stats
- coefficients and SEs from a unvariate model with continuous and factor predictors. SEs were checked against Stata.</code></pre>
<p>Where tests are for/from a specific version of the package, as might
be the case for newly added or deprecated functions, this should also be
noted.</p>
</div>
<div class="section level3">
<h3 id="setup-stats-r">
<code>setup-stats.R</code><a class="anchor" aria-label="anchor" href="#setup-stats-r"></a>
</h3>
<p>This file should contain the code necessary to load the package and
any other packages that are required for the tests. In this case, we
need the <code>stats</code> package and the <code>testthat</code>
package.</p>
<p>The testthat package is always needed. In general, loading the
package is necessary. As <code>stats</code> is a standard R package,
it’s no necessary in this case.</p>
<p>We also try to leave the environment as we found it, so we detach the
packages via the <code><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">withr::defer</a></code> function. Again, in this
case, we don’t want to detach it, as it is a standard package.</p>
<pre><code><span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"stats"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org" class="external-link">testthat</a></span><span class="op">)</span></span>
<span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html" class="external-link">defer</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># most of the time, we would want to detach packages, in this case we don't</span></span>
<span>  <span class="co"># detach(package:stats)</span></span>
<span><span class="op">}</span>, <span class="fu"><a href="https://testthat.r-lib.org/reference/teardown_env.html" class="external-link">teardown_env</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="testing-that-the-tests-work">Testing that the tests work<a class="anchor" aria-label="anchor" href="#testing-that-the-tests-work"></a>
</h3>
<p>Assuming the tests are in a folder called <code>stats</code>, which
is within out current working directory, we can run the tests with:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">validation</span><span class="fu">::</span><span class="fu"><a href="../reference/test.html">test</a></span><span class="op">(</span><span class="st">"stats"</span>, download <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We specify <code>download = FALSE</code> because
<code><a href="../reference/test.html">validation::test</a></code> will download the files from GitHub and
run those tests by default. <code>download = FALSE</code> tells it to
use the local copy of the files instead.</p>
<p>The output should return various information on our tests and system.
The first part comes from testthat itself while it runs the tests, the
remainder (after “Copy and paste the following…”) provides summary
information that should be copied into a github issue :</p>
<pre><code>✔ | F W  S  OK | Context
✔ |          7 | lm                                                                          

══ Results ══════════════════════════════════════════════════════════════════════════════════
[ FAIL 0 | WARN 0 | SKIP 0 | PASS 7 ]
## Copy and paste the following output into the indicated sections of a new issue

ISSUE NAME: 
[Package test]: stats version 4.3.1 

### Name of the package you have validated: 
stats 

### What version of the package have you validated? 
4.3.1 

### When was this package tested? 
2024-03-18 

### What was tested? 
Tests for package stats 
 - coefficients and SEs from a unvariate model with continuous and factor predictors. SEs were checked against Stata. 
 

### Test results 
PASS 

### Test output:


|file      |context |test                                 | nb| passed|skipped |error | warning|
|:---------|:-------|:------------------------------------|--:|------:|:-------|:-----|-------:|
|test-lm.R |lm      |lm returns the expected coefficients |  8|      4|FALSE   |FALSE |       4|
|test-lm.R |lm      |Standard errors from lm are correct  |  3|      3|FALSE   |FALSE |       0|

### SessionInfo:
R version 4.3.1 (2023-06-16 ucrt)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 19045)

Matrix products: default


locale:
[1] LC_COLLATE=German_Switzerland.utf8  LC_CTYPE=German_Switzerland.utf8   
[3] LC_MONETARY=German_Switzerland.utf8 LC_NUMERIC=C                       
[5] LC_TIME=German_Switzerland.utf8    

time zone: Europe/Zurich
tzcode source: internal

attached base packages:
[1] graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] gh_1.4.0         validation_0.1.0 testthat_3.2.0  

loaded via a namespace (and not attached):
 [1] xfun_0.40         httr2_0.2.3       htmlwidgets_1.6.2 devtools_2.4.5   
 [5] remotes_2.4.2.1   processx_3.8.2    callr_3.7.3       vctrs_0.6.5      
 [9] tools_4.3.1       ps_1.7.5          generics_0.1.3    curl_5.1.0       
[13] tibble_3.2.1      fansi_1.0.6       pkgconfig_2.0.3   desc_1.4.2       
[17] lifecycle_1.0.4   compiler_4.3.1    stringr_1.5.1     brio_1.1.3       
[21] httpuv_1.6.12     htmltools_0.5.6.1 usethis_2.2.2     yaml_2.3.8       
[25] pkgdown_2.0.7     tidyr_1.3.0       later_1.3.1       pillar_1.9.0     
[29] crayon_1.5.2      urlchecker_1.0.1  ellipsis_0.3.2    cranlogs_2.1.1   
[33] rsconnect_1.1.1   cachem_1.0.8      sessioninfo_1.2.2 mime_0.12        
[37] tidyselect_1.2.0  digest_0.6.33     stringi_1.8.3     dplyr_1.1.4      
[41] purrr_1.0.2       rprojroot_2.0.3   fastmap_1.1.1     cli_3.6.2        
[45] magrittr_2.0.3    pkgbuild_1.4.2    utf8_1.2.4        withr_3.0.0      
[49] waldo_0.5.1       prettyunits_1.2.0 promises_1.2.1    rappdirs_0.3.3   
[53] roxygen2_7.3.0    rmarkdown_2.25    httr_1.4.7        gitcreds_0.1.2   
[57] stats_4.3.1       memoise_2.0.1     shiny_1.8.0       evaluate_0.22    
[61] knitr_1.45        miniUI_0.1.1.1    profvis_0.3.8     rlang_1.1.3      
[65] Rcpp_1.0.11       xtable_1.8-4      glue_1.7.0        xml2_1.3.5       
[69] pkgload_1.3.3     rstudioapi_0.15.0 jsonlite_1.8.7    R6_2.5.1         
[73] fs_1.6.3         


### Where is the test code located for these tests?
please enter manually

### Where the test code is located in a git repository, add the git commit SHA
please enter manually, if relevant</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="hints-for-working-with-github">Hints for working with GitHub<a class="anchor" aria-label="anchor" href="#hints-for-working-with-github"></a>
</h2>
<p>RStudio has a built-in git interface, which is a good way to manage
your git repositories if you use RStudio.</p>
<p>The <a href="https://happygitwithr.com/" class="external-link">Happy Git and GitHub for the
useR</a> book is a comprehensive guide to working with git and GitHub.
Of particular use are chapters 9 to 12 on connecting your computer with
GitHub.</p>
<p>The GitHub desktop app is a good way to manage your git repositories
if you are not comfortable with the command line. This is also an easy
way to connect your computer with your GitHub account. There are many
other GUIs for working with git repositories. See <a href="https://git-scm.com/downloads/guis" class="external-link">here for a listing of some of
them</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alan G. Haynes.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
